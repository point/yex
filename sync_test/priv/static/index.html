<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Yex Sync Demo - XmlFragment, Array & Map</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }
    h1 { color: #333; margin-bottom: 8px; }
    .subtitle { color: #666; margin-bottom: 20px; }
    #status {
      padding: 10px 16px;
      border-radius: 6px;
      margin-bottom: 16px;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
    }
    .connected { background: #d4edda; color: #155724; }
    .connected .status-dot { background: #28a745; }
    .disconnected { background: #f8d7da; color: #721c24; }
    .disconnected .status-dot { background: #dc3545; }
    .connecting { background: #fff3cd; color: #856404; }
    .connecting .status-dot { background: #ffc107; animation: pulse 1s infinite; }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    /* Demo Grid */
    .demo-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }
    @media (max-width: 900px) {
      .demo-grid { grid-template-columns: 1fr; }
    }

    .demo-section {
      background: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .demo-section h2 {
      margin: 0 0 4px 0;
      font-size: 18px;
      color: #333;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .demo-section h2 .badge {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 12px;
      font-weight: 500;
    }
    .badge-xml { background: #e3f2fd; color: #1565c0; }
    .badge-array { background: #f3e5f5; color: #7b1fa2; }
    .badge-map { background: #e8f5e9; color: #2e7d32; }
    .demo-section .description {
      color: #666;
      font-size: 13px;
      margin-bottom: 16px;
    }

    /* Toolbar */
    .toolbar {
      display: flex;
      gap: 4px;
      padding: 8px 12px;
      background: #f8f9fa;
      border: 1px solid #ddd;
      border-bottom: none;
      border-radius: 8px 8px 0 0;
      flex-wrap: wrap;
    }
    .toolbar button {
      padding: 6px 12px;
      border: 1px solid #ccc;
      background: white;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
    }
    .toolbar button:hover {
      background: #e9ecef;
    }
    .toolbar button.active {
      background: #007bff;
      color: white;
      border-color: #007bff;
    }
    .toolbar .separator {
      width: 1px;
      background: #ddd;
      margin: 0 8px;
    }

    #editor-container {
      background: white;
      border: 1px solid #ddd;
      border-radius: 0 0 8px 8px;
    }
    #editor {
      min-height: 200px;
      padding: 16px;
      font-size: 15px;
      line-height: 1.5;
    }

    /* ProseMirror styles */
    .ProseMirror {
      outline: none;
      min-height: 160px;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    .ProseMirror p {
      margin: 0 0 0.8em 0;
    }
    .ProseMirror h1, .ProseMirror h2, .ProseMirror h3 {
      margin: 1em 0 0.5em 0;
      line-height: 1.2;
    }
    .ProseMirror h1 { font-size: 1.6em; }
    .ProseMirror h2 { font-size: 1.3em; }
    .ProseMirror h3 { font-size: 1.1em; }
    .ProseMirror strong { font-weight: bold; }
    .ProseMirror em { font-style: italic; }
    .ProseMirror code {
      background: #f4f4f4;
      padding: 2px 4px;
      border-radius: 3px;
      font-family: monospace;
    }
    .ProseMirror pre {
      background: #f4f4f4;
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
    }
    .ProseMirror pre code {
      background: none;
      padding: 0;
    }
    .ProseMirror ul, .ProseMirror ol {
      padding-left: 1.5em;
      margin: 0 0 0.8em 0;
    }
    .ProseMirror blockquote {
      border-left: 3px solid #ddd;
      margin: 0 0 0.8em 0;
      padding-left: 1em;
      color: #666;
    }

    /* Array Demo */
    .array-controls {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }
    .array-controls input {
      flex: 1;
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    .array-controls button {
      padding: 8px 16px;
      border: none;
      background: #7b1fa2;
      color: white;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 500;
    }
    .array-controls button:hover {
      background: #6a1b9a;
    }
    .array-list {
      border: 1px solid #e0e0e0;
      border-radius: 4px;
      max-height: 250px;
      overflow-y: auto;
    }
    .array-item {
      display: flex;
      align-items: center;
      padding: 10px 12px;
      border-bottom: 1px solid #e0e0e0;
      gap: 10px;
    }
    .array-item:last-child {
      border-bottom: none;
    }
    .array-item .index {
      color: #999;
      font-size: 12px;
      min-width: 24px;
    }
    .array-item .value {
      flex: 1;
      font-size: 14px;
    }
    .array-item .delete-btn {
      padding: 4px 10px;
      border: none;
      background: #ffebee;
      color: #c62828;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }
    .array-item .delete-btn:hover {
      background: #ffcdd2;
    }
    .array-empty {
      padding: 20px;
      text-align: center;
      color: #999;
      font-style: italic;
    }

    /* Map Demo */
    .map-controls {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }
    .map-controls input {
      flex: 1;
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    .map-controls input:first-child {
      max-width: 120px;
    }
    .map-controls button {
      padding: 8px 16px;
      border: none;
      background: #2e7d32;
      color: white;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 500;
    }
    .map-controls button:hover {
      background: #1b5e20;
    }
    .map-list {
      border: 1px solid #e0e0e0;
      border-radius: 4px;
      max-height: 250px;
      overflow-y: auto;
    }
    .map-item {
      display: flex;
      align-items: center;
      padding: 10px 12px;
      border-bottom: 1px solid #e0e0e0;
      gap: 10px;
    }
    .map-item:last-child {
      border-bottom: none;
    }
    .map-item .key {
      font-weight: 600;
      color: #2e7d32;
      min-width: 80px;
      font-size: 14px;
    }
    .map-item .value {
      flex: 1;
      font-size: 14px;
      color: #333;
    }
    .map-item .delete-btn {
      padding: 4px 10px;
      border: none;
      background: #ffebee;
      color: #c62828;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }
    .map-item .delete-btn:hover {
      background: #ffcdd2;
    }
    .map-empty {
      padding: 20px;
      text-align: center;
      color: #999;
      font-style: italic;
    }

    /* Full-width editor section */
    .editor-section {
      grid-column: 1 / -1;
    }

    .debug {
      margin-top: 20px;
      padding: 16px;
      background: #f8f9fa;
      border-radius: 6px;
      font-family: monospace;
      font-size: 12px;
    }
    .debug h3 { margin: 0 0 10px 0; font-size: 14px; color: #666; }
    #debug-content { white-space: pre-wrap; word-break: break-all; color: #333; }
  </style>
</head>
<body>
  <h1>Yex Sync Demo</h1>
  <p class="subtitle">Open this page in multiple browser tabs to test real-time synchronization of Y.js types via Elixir backend</p>

  <div id="status" class="connecting">
    <span class="status-dot"></span>
    <span id="status-text">Connecting...</span>
  </div>

  <div class="demo-grid">
    <!-- Array Demo -->
    <div class="demo-section">
      <h2>Shared List <span class="badge badge-array">Y.Array</span></h2>
      <p class="description">Add, remove items - synced across all tabs in real-time</p>
      <div class="array-controls">
        <input type="text" id="array-input" placeholder="Enter item..." />
        <button id="array-add">Add Item</button>
      </div>
      <div class="array-list" id="array-list">
        <div class="array-empty">No items yet. Add one above!</div>
      </div>
    </div>

    <!-- Map Demo -->
    <div class="demo-section">
      <h2>Settings <span class="badge badge-map">Y.Map</span></h2>
      <p class="description">Key-value pairs synced across all tabs</p>
      <div class="map-controls">
        <input type="text" id="map-key" placeholder="Key" />
        <input type="text" id="map-value" placeholder="Value" />
        <button id="map-set">Set</button>
      </div>
      <div class="map-list" id="map-list">
        <div class="map-empty">No settings yet. Add one above!</div>
      </div>
    </div>

    <!-- Editor Section (full width) -->
    <div class="demo-section editor-section">
      <h2>Rich Text Editor <span class="badge badge-xml">Y.XmlFragment</span></h2>
      <p class="description">Collaborative rich text editing with formatting support</p>
      <div class="toolbar">
        <button id="btn-bold" title="Bold (Ctrl+B)"><strong>B</strong></button>
        <button id="btn-italic" title="Italic (Ctrl+I)"><em>I</em></button>
        <button id="btn-code" title="Code"><code>&lt;&gt;</code></button>
        <div class="separator"></div>
        <button id="btn-h1" title="Heading 1">H1</button>
        <button id="btn-h2" title="Heading 2">H2</button>
        <button id="btn-h3" title="Heading 3">H3</button>
        <button id="btn-paragraph" title="Paragraph">P</button>
        <div class="separator"></div>
        <button id="btn-bullet" title="Bullet List">&#8226; List</button>
        <button id="btn-ordered" title="Numbered List">1. List</button>
        <button id="btn-blockquote" title="Quote">"</button>
        <div class="separator"></div>
        <button id="btn-undo" title="Undo (Ctrl+Z)">Undo</button>
        <button id="btn-redo" title="Redo (Ctrl+Y)">Redo</button>
      </div>
      <div id="editor-container">
        <div id="editor"></div>
      </div>
    </div>
  </div>

  <div class="debug">
    <h3>Debug Info</h3>
    <div id="debug-content">Initializing...</div>
  </div>

  <!-- Phoenix JS -->
  <script src="https://cdn.jsdelivr.net/npm/phoenix@1.7.10/priv/static/phoenix.min.js"></script>

  <script type="importmap">
    {
      "imports": {
        "yjs": "https://esm.sh/yjs@13.6.8",
        "y-prosemirror": "https://esm.sh/y-prosemirror@1.2.5?external=yjs,prosemirror-state,prosemirror-view,prosemirror-model",
        "prosemirror-state": "https://esm.sh/prosemirror-state@1.4.3?external=prosemirror-model,prosemirror-transform",
        "prosemirror-view": "https://esm.sh/prosemirror-view@1.33.1?external=prosemirror-model,prosemirror-state,prosemirror-transform",
        "prosemirror-model": "https://esm.sh/prosemirror-model@1.19.3",
        "prosemirror-transform": "https://esm.sh/prosemirror-transform@1.8.0?external=prosemirror-model",
        "prosemirror-schema-basic": "https://esm.sh/prosemirror-schema-basic@1.2.2?external=prosemirror-model",
        "prosemirror-schema-list": "https://esm.sh/prosemirror-schema-list@1.3.0?external=prosemirror-model,prosemirror-transform,prosemirror-state",
        "prosemirror-keymap": "https://esm.sh/prosemirror-keymap@1.2.2?external=prosemirror-state",
        "prosemirror-commands": "https://esm.sh/prosemirror-commands@1.5.2?external=prosemirror-model,prosemirror-state,prosemirror-transform",
        "prosemirror-history": "https://esm.sh/prosemirror-history@1.4.0?external=prosemirror-state,prosemirror-transform,prosemirror-view"
      }
    }
  </script>
  <script type="module">
    import * as Y from 'yjs';
    import { ySyncPlugin, yCursorPlugin, yUndoPlugin, undo, redo } from 'y-prosemirror';
    import { EditorState } from 'prosemirror-state';
    import { EditorView } from 'prosemirror-view';
    import { Schema, DOMParser } from 'prosemirror-model';
    import { schema as basicSchema } from 'prosemirror-schema-basic';
    import { addListNodes, wrapInList, splitListItem, liftListItem, sinkListItem } from 'prosemirror-schema-list';
    import { keymap } from 'prosemirror-keymap';
    import { baseKeymap, toggleMark, setBlockType, wrapIn } from 'prosemirror-commands';
    import { history } from 'prosemirror-history';

    // Debug helper
    const debugEl = document.getElementById('debug-content');
    function debug(msg) {
      console.log('[YEX]', msg);
      debugEl.textContent = msg;
    }

    // Status helper
    const statusEl = document.getElementById('status');
    const statusTextEl = document.getElementById('status-text');
    function setStatus(status, text) {
      statusEl.className = status;
      statusTextEl.textContent = text;
    }

    // ========================================
    // Schema with list support
    // ========================================
    const mySchema = new Schema({
      nodes: addListNodes(basicSchema.spec.nodes, "paragraph block*", "block"),
      marks: basicSchema.spec.marks
    });

    // ========================================
    // Y.js Setup - All shared types
    // ========================================
    debug('Creating Y.Doc with shared types...');
    const ydoc = new Y.Doc();

    // Get all shared types
    const yxmlFragment = ydoc.getXmlFragment('prosemirror');  // Rich text editor
    const yarray = ydoc.getArray('items');                     // Shared list
    const ymap = ydoc.getMap('settings');                      // Shared key-value store

    // ========================================
    // Array UI
    // ========================================
    const arrayListEl = document.getElementById('array-list');
    const arrayInputEl = document.getElementById('array-input');

    function renderArray() {
      const items = yarray.toArray();
      if (items.length === 0) {
        arrayListEl.innerHTML = '<div class="array-empty">No items yet. Add one above!</div>';
        return;
      }
      arrayListEl.innerHTML = items.map((item, index) => `
        <div class="array-item">
          <span class="index">[${index}]</span>
          <span class="value">${escapeHtml(String(item))}</span>
          <button class="delete-btn" data-index="${index}">Delete</button>
        </div>
      `).join('');

      // Add delete handlers
      arrayListEl.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const index = parseInt(btn.dataset.index);
          yarray.delete(index, 1);
        });
      });
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Add item button
    document.getElementById('array-add').addEventListener('click', () => {
      const value = arrayInputEl.value.trim();
      if (value) {
        yarray.push([value]);
        arrayInputEl.value = '';
        arrayInputEl.focus();
      }
    });

    // Enter key to add
    arrayInputEl.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        document.getElementById('array-add').click();
      }
    });

    // Observe array changes
    yarray.observe(() => {
      renderArray();
      debug(`Array updated: ${yarray.length} items`);
    });

    // ========================================
    // Map UI
    // ========================================
    const mapListEl = document.getElementById('map-list');
    const mapKeyEl = document.getElementById('map-key');
    const mapValueEl = document.getElementById('map-value');

    function renderMap() {
      const entries = Array.from(ymap.entries());
      if (entries.length === 0) {
        mapListEl.innerHTML = '<div class="map-empty">No settings yet. Add one above!</div>';
        return;
      }
      mapListEl.innerHTML = entries.map(([key, value]) => `
        <div class="map-item">
          <span class="key">${escapeHtml(key)}</span>
          <span class="value">${escapeHtml(String(value))}</span>
          <button class="delete-btn" data-key="${escapeHtml(key)}">Delete</button>
        </div>
      `).join('');

      // Add delete handlers
      mapListEl.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const key = btn.dataset.key;
          ymap.delete(key);
        });
      });
    }

    // Set value button
    document.getElementById('map-set').addEventListener('click', () => {
      const key = mapKeyEl.value.trim();
      const value = mapValueEl.value.trim();
      if (key && value) {
        ymap.set(key, value);
        mapKeyEl.value = '';
        mapValueEl.value = '';
        mapKeyEl.focus();
      }
    });

    // Enter key to set
    mapValueEl.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        document.getElementById('map-set').click();
      }
    });

    // Observe map changes
    ymap.observe(() => {
      renderMap();
      debug(`Map updated: ${ymap.size} entries`);
    });

    // ========================================
    // Phoenix Socket Connection
    // ========================================
    debug('Connecting to Phoenix socket...');
    const socket = new Phoenix.Socket("/socket", {});
    socket.connect();

    const channel = socket.channel("sync:lobby", {});

    // Listen for Y.js local changes and send to server (V2 format)
    ydoc.on('updateV2', (update, origin) => {
      if (origin === 'remote') return;

      debug(`Local Y.js update (V2): ${update.length} bytes`);
      const data = btoa(String.fromCharCode.apply(null, update));
      channel.push("update", { data: data })
        .receive("ok", () => debug('Update sent successfully'))
        .receive("error", (err) => debug(`Update error: ${JSON.stringify(err)}`));
    });

    // Receive initial state from server (V2 format)
    channel.on("sync_state", (msg) => {
      debug('Received initial state from server');
      try {
        const binary = atob(msg.data);
        const update = new Uint8Array(binary.length);
        for (let i = 0; i < binary.length; i++) {
          update[i] = binary.charCodeAt(i);
        }
        Y.applyUpdateV2(ydoc, update, 'remote');
        setStatus('connected', 'Connected & Synced');
        debug(`Synced! Array: ${yarray.length} items, Map: ${ymap.size} entries, Fragment: ${yxmlFragment.length} children`);

        // Initial render
        renderArray();
        renderMap();
      } catch (e) {
        debug(`Error applying initial state: ${e.message}`);
        console.error(e);
      }
    });

    // Receive updates from other clients (V2 format)
    channel.on("update", (msg) => {
      debug('Received update from another client');
      try {
        const binary = atob(msg.data);
        const update = new Uint8Array(binary.length);
        for (let i = 0; i < binary.length; i++) {
          update[i] = binary.charCodeAt(i);
        }
        Y.applyUpdateV2(ydoc, update, 'remote');
        debug(`Applied remote update. Array: ${yarray.length}, Map: ${ymap.size}, Fragment: ${yxmlFragment.length}`);
      } catch (e) {
        debug(`Error applying update: ${e.message}`);
        console.error(e);
      }
    });

    // Join the channel
    channel.join()
      .receive("ok", () => {
        setStatus('connecting', 'Connected, syncing...');
        debug('Joined sync:lobby channel');
      })
      .receive("error", (resp) => {
        setStatus('disconnected', 'Failed to join channel');
        debug(`Join error: ${JSON.stringify(resp)}`);
      });

    // Handle disconnection
    socket.onClose(() => {
      setStatus('disconnected', 'Disconnected');
      debug('Socket closed');
    });
    socket.onError(() => {
      setStatus('disconnected', 'Connection error');
      debug('Socket error');
    });

    // ========================================
    // ProseMirror Setup
    // ========================================
    debug('Setting up ProseMirror editor...');

    // Keyboard shortcuts for formatting
    const customKeymap = keymap({
      'Mod-z': undo,
      'Mod-y': redo,
      'Mod-Shift-z': redo,
      'Mod-b': toggleMark(mySchema.marks.strong),
      'Mod-i': toggleMark(mySchema.marks.em),
      'Mod-`': toggleMark(mySchema.marks.code),
      'Enter': splitListItem(mySchema.nodes.list_item),
      'Mod-[': liftListItem(mySchema.nodes.list_item),
      'Mod-]': sinkListItem(mySchema.nodes.list_item),
    });

    // Create editor
    const editorEl = document.getElementById('editor');
    const view = new EditorView(editorEl, {
      state: EditorState.create({
        schema: mySchema,
        plugins: [
          ySyncPlugin(yxmlFragment),
          yUndoPlugin(),
          customKeymap,
          keymap(baseKeymap),
          history()
        ]
      })
    });

    // ========================================
    // Toolbar buttons
    // ========================================
    function isMarkActive(markType) {
      const state = view.state;
      const { from, $from, to, empty } = state.selection;
      if (empty) return markType.isInSet(state.storedMarks || $from.marks());
      return state.doc.rangeHasMark(from, to, markType);
    }

    function updateToolbar() {
      document.getElementById('btn-bold').classList.toggle('active', isMarkActive(mySchema.marks.strong));
      document.getElementById('btn-italic').classList.toggle('active', isMarkActive(mySchema.marks.em));
      document.getElementById('btn-code').classList.toggle('active', isMarkActive(mySchema.marks.code));
    }

    // Update toolbar on selection change
    view.setProps({
      dispatchTransaction(transaction) {
        const newState = view.state.apply(transaction);
        view.updateState(newState);
        updateToolbar();
      }
    });

    // Bold
    document.getElementById('btn-bold').addEventListener('click', () => {
      toggleMark(mySchema.marks.strong)(view.state, view.dispatch);
      view.focus();
    });

    // Italic
    document.getElementById('btn-italic').addEventListener('click', () => {
      toggleMark(mySchema.marks.em)(view.state, view.dispatch);
      view.focus();
    });

    // Code
    document.getElementById('btn-code').addEventListener('click', () => {
      toggleMark(mySchema.marks.code)(view.state, view.dispatch);
      view.focus();
    });

    // Headings
    document.getElementById('btn-h1').addEventListener('click', () => {
      setBlockType(mySchema.nodes.heading, { level: 1 })(view.state, view.dispatch);
      view.focus();
    });
    document.getElementById('btn-h2').addEventListener('click', () => {
      setBlockType(mySchema.nodes.heading, { level: 2 })(view.state, view.dispatch);
      view.focus();
    });
    document.getElementById('btn-h3').addEventListener('click', () => {
      setBlockType(mySchema.nodes.heading, { level: 3 })(view.state, view.dispatch);
      view.focus();
    });
    document.getElementById('btn-paragraph').addEventListener('click', () => {
      setBlockType(mySchema.nodes.paragraph)(view.state, view.dispatch);
      view.focus();
    });

    // Lists
    document.getElementById('btn-bullet').addEventListener('click', () => {
      wrapInList(mySchema.nodes.bullet_list)(view.state, view.dispatch);
      view.focus();
    });
    document.getElementById('btn-ordered').addEventListener('click', () => {
      wrapInList(mySchema.nodes.ordered_list)(view.state, view.dispatch);
      view.focus();
    });

    // Blockquote
    document.getElementById('btn-blockquote').addEventListener('click', () => {
      wrapIn(mySchema.nodes.blockquote)(view.state, view.dispatch);
      view.focus();
    });

    // Undo/Redo
    document.getElementById('btn-undo').addEventListener('click', () => {
      undo(view.state, view.dispatch);
      view.focus();
    });
    document.getElementById('btn-redo').addEventListener('click', () => {
      redo(view.state, view.dispatch);
      view.focus();
    });

    debug('Editor ready! Start typing...');

    // ========================================
    // Debug: Expose to console
    // ========================================
    window.ydoc = ydoc;
    window.yxmlFragment = yxmlFragment;
    window.yarray = yarray;
    window.ymap = ymap;
    window.view = view;
    window.channel = channel;
    window.Y = Y;

    console.log('%c Yex Sync Demo ', 'background: #6366f1; color: white; font-size: 14px; padding: 4px 8px; border-radius: 4px;');
    console.log('Debug objects: window.ydoc, window.yxmlFragment, window.yarray, window.ymap, window.view, window.channel');
    console.log('Try in console: yarray.push(["test"]) or ymap.set("key", "value")');
  </script>
</body>
</html>
